<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>元元DIY邮箱生成器</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on touch devices */
        }

        html {
            -webkit-text-size-adjust: 100%; /* Prevent font scaling in landscape */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            font-size: 16px; /* Base font size */
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 1.5em; /* Use em for scalability */
            margin: 0;
            font-weight: 600;
        }

        /* --- Input and Control Groups --- */

        .control-group {
            display: flex; /* Use flexbox for layout */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            gap: 20px; /* Space between items */
            margin-bottom: 25px;
            align-items: center; /* Align items vertically */
        }

        .input-group {
            flex: 1 1 250px; /* Allow growing and shrinking, base width */
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0; /* Prevent overflow */
        }

        .input-group label {
            font-size: 0.875em; /* 14px */
            white-space: nowrap;
            color: #555;
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        /* Input base style */
        .input-group input {
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.875em; /* 14px */
            background: #fff;
            flex-grow: 1; /* Take available space */
            min-width: 0; /* Prevent overflow */
            height: 40px; /* Consistent height */
            line-height: normal; /* Reset line height for input */
        }
        /* Ensure number input looks consistent */
        .input-group input[type="number"] {
             -moz-appearance: textfield;
        }
        .input-group input[type="number"]::-webkit-outer-spin-button,
        .input-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Input with Spinners */
        .input-with-spinners {
            position: relative;
            display: inline-flex; /* Use inline-flex */
            align-items: center;
            flex-grow: 1;
            min-width: 0;
        }

        .input-with-spinners input {
            padding-right: 30px; /* Space for spinners */
            width: 100%; /* Fill container */
        }

        .spinner-buttons {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            width: 24px;
            display: flex;
            flex-direction: column;
            background-color: #f8f8f8;
            border-left: 1px solid #ccc;
            border-radius: 0 5px 5px 0;
            overflow: hidden; /* Ensure rounded corners apply */
        }

        .spinner-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1; /* Take half the height */
            padding: 0;
            border: none;
            background: none;
            font-size: 10px;
            color: #555;
            cursor: pointer;
            line-height: 1; /* Ensure icon is centered */
            user-select: none; /* Prevent text selection */
        }
        .spinner-btn:hover {
            background-color: #eee;
        }
        .spinner-btn:active {
            background-color: #ddd;
        }

        /* --- Buttons --- */

        /* Button base style */
        .btn {
            padding: 0 16px; /* Use padding for horizontal sizing */
            border: none;
            border-radius: 6px;
            font-size: 0.875em; /* 14px */
            font-weight: 500;
            height: 40px;
            display: inline-flex; /* Use inline-flex */
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            line-height: 1; /* Align text vertically */
            flex-shrink: 0; /* Prevent shrinking in flex containers */
        }
        .btn:active {
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Reset Button */
        .btn-reset {
            background-color: var(--primary-color);
            color: white;
            min-width: 60px; /* Ensure minimum width */
        }
        .btn-reset:hover {
            background-color: #45a049;
        }

        /* Button Groups */
        .action-buttons,
        .selection-tools,
        .sort-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Main Action/Tool Buttons */
        .btn-main {
            background-color: var(--secondary-color);
            color: white;
            flex: 1 1 auto; /* Default: allow growing, shrinking, automatic base size */
        }
         .btn-main:hover {
            background-color: #1e88e5;
        }


        /* Range Input Specifics */
        .selection-tools .range-input {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 200px; /* Allow growing/shrinking, base width */
            min-width: 180px; /* Prevent becoming too small */
        }

        .selection-tools .range-input input {
            flex-grow: 1; /* Input takes most space */
            min-width: 80px; /* Minimum width for the input field */
            height: 40px; /* Match button height */
            padding: 10px 12px; /* Match other inputs */
            font-size: 0.875em; /* Match other inputs */
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff; /* Ensure background */
            line-height: normal; /* Reset line height */
            appearance: none; /* Reset appearance */
             -webkit-appearance: none;
        }
        .selection-tools .range-input .btn-main {
             flex-grow: 0; /* Don't allow button to grow */
             flex-shrink: 0; /* Don't allow button to shrink */
             /* Width determined by padding */
        }


        /* --- Output Area --- */

        #output-container {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            max-height: 50vh; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            background-color: #f9f9f9;
        }

        .email-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #eee;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        .email-item:last-child {
            margin-bottom: 0;
        }

        .checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
            flex-shrink: 0;
        }

        .email-info {
            flex-grow: 1;
            margin-right: 10px;
            font-size: 0.875em; /* 14px */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: default; /* Default cursor over text */
        }

        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8125em; /* 13px */
            height: 32px; /* Smaller height */
            min-width: 60px;
            flex-shrink: 0;
        }
         .copy-btn:hover {
             background-color: #45a049;
         }

        .selected {
            background-color: #e3f2fd !important; /* Use important to override potential hover */
            border-color: var(--secondary-color);
        }

        /* --- Loading Spinner --- */
        .loading-overlay {
            position: fixed;
            inset: 0; /* Replaces top, left, right, bottom */
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Responsive Adjustments --- */

        /* Medium screens and Tablets */
        @media (max-width: 768px) {
             .control-group {
                 gap: 15px;
             }
             .input-group {
                 /* Allow slightly smaller base width if needed */
                 flex-basis: 220px;
             }
        }


        /* Smaller screens (Mobile) */
        @media (max-width: 600px) {
            body {
                padding: 15px; /* Slightly reduce body padding */
            }
            .container {
                padding: 20px; /* Reduce container padding */
            }
            .header h1 {
                font-size: 1.3em; /* Adjust header size */
            }

            .control-group {
                flex-direction: column; /* Stack controls vertically */
                align-items: stretch; /* Make items full width */
                gap: 15px; /* Adjust gap for vertical layout */
            }

            .input-group {
                flex-basis: auto; /* Reset flex-basis */
                width: 100%; /* Ensure full width */
            }

            /* --- Button Group Layout Fix for Mobile --- */
            .action-buttons,
            .selection-tools,
            .sort-buttons {
                 gap: 12px; /* Adjust gap for vertical stacking */
            }

             /* Make main buttons in groups stack vertically (take full width) */
            .action-buttons .btn-main,
            .selection-tools .btn-main, /* Target direct children buttons */
            .sort-buttons .btn-main {
                 flex: 0 0 100%; /* Don't grow, don't shrink, full width basis */
                 width: 100%;   /* Explicitly set width to 100% */
            }

            /* Ensure range input group also takes full width */
             .selection-tools .range-input {
                 flex: 0 0 100%; /* Don't grow, don't shrink, full width basis */
                 width: 100%;
                 min-width: unset; /* Remove min-width constraint */
             }
             /* Keep the button *inside* range-input constrained */
             .selection-tools .range-input .btn-main {
                 flex: 0 0 auto; /* Don't grow, don't shrink, auto width based on content/padding */
                 width: auto;    /* Reset width to auto */
                 min-width: 100px; /* Ensure it remains tappable */
             }
            /* Ensure the input *inside* range-input still grows */
             .selection-tools .range-input input {
                 flex-grow: 1;
                 flex-basis: 0; /* Allow input to take remaining space */
             }
             /* --- End Button Group Layout Fix --- */


            #output-container {
                max-height: 45vh; /* Adjust max height */
            }
            .email-item {
                padding: 8px 10px;
            }
        }

        /* Very Narrow Screens */
        @media (max-width: 400px) {
            body {
                padding: 10px; /* Further reduce padding */
            }
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 1.2em;
            }

            /* Reduce height and font for inputs/buttons */
            .input-group input, .btn {
                height: 38px;
                font-size: 0.8125em; /* 13px */
            }
            /* Adjust padding to keep text centered */
             .input-group input { padding: 8px 10px; }
             .btn { padding: 0 12px; }
             .selection-tools .range-input input { padding: 8px 10px; } /* Match range input padding */


            .input-group label {
                font-size: 0.8125em; /* 13px */
            }

            .spinner-buttons {
                width: 22px; /* Slightly smaller spinners */
            }
            .spinner-btn {
                font-size: 9px;
            }

            .email-info {
                font-size: 0.8125em; /* 13px */
            }
            .copy-btn {
                height: 30px;
                padding: 4px 10px;
                font-size: 0.75em; /* 12px */
                min-width: 50px;
            }
            .checkbox {
                width: 16px;
                height: 16px;
                margin-right: 10px;
            }

            .action-buttons,
            .selection-tools,
            .sort-buttons {
                gap: 10px; /* Reduce gap between buttons */
                margin-bottom: 15px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>元元DIY邮箱生成器</h1>
        </div>

        <div class="control-group">
            <div class="input-group">
                <label for="dateSuffix">日期后缀</label>
                <div class="input-with-spinners">
                    <input type="text" id="dateSuffix" inputmode="numeric" pattern="[0-9]{4}" placeholder="MMDD">
                    <div class="spinner-buttons">
                        <button type="button" class="spinner-btn" onclick="adjustDateSuffix(1)" aria-label="增加一天">▲</button>
                        <button type="button" class="spinner-btn" onclick="adjustDateSuffix(-1)" aria-label="减少一天">▼</button>
                    </div>
                </div>
                <button class="btn btn-reset" onclick="resetDateSuffix()">恢复</button>
            </div>
            <div class="input-group">
                <label for="emailDomain">邮箱域名</label>
                <input type="text" id="emailDomain" value="@e.edu.kg">
                <button class="btn btn-reset" onclick="resetEmailDomain()">恢复</button>
            </div>
            <div class="input-group">
                <label for="emailCount">生成数量</label>
                <div class="input-with-spinners">
                    <input type="number" id="emailCount" value="100" min="1" max="576">
                    <div class="spinner-buttons">
                        <button type="button" class="spinner-btn" onclick="adjustEmailCount(1)" aria-label="增加数量">▲</button>
                        <button type="button" class="spinner-btn" onclick="adjustEmailCount(-1)" aria-label="减少数量">▼</button>
                    </div>
                </div>
                <button class="btn btn-reset" onclick="resetEmailCount()">恢复</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-main" onclick="generateData()">生成数据</button>
            <button class="btn btn-main" onclick="copyAll()">复制全部</button>
            <button class="btn btn-main" onclick="exportTXT()">导出TXT</button>
        </div>

        <div class="selection-tools">
            <button class="btn btn-main" onclick="selectAll()">全选</button>
            <button class="btn btn-main" onclick="invertSelection()">反选</button>
            <button class="btn btn-main" onclick="copySelected()">复制选中</button>
            <div class="range-input">
                <input type="text" id="copyRange" placeholder="例: 1-5" inputmode="numeric"> <!-- Added inputmode -->
                <button class="btn btn-main" onclick="copyRange()">复制范围</button>
            </div>
        </div>

        <div class="sort-buttons">
            <button class="btn btn-main" onclick="sortData('asc')">顺序排序</button>
            <button class="btn btn-main" onclick="sortData('desc')">倒序排序</button>
            <button class="btn btn-main" onclick="sortData('random')">随机排序</button>
        </div>

        <div id="output-container"></div>
    </div>

<script>
// 邮箱前缀数组 (Assuming this remains unchanged)
const email_prefixes = [
'aa','bb','cc','dd','ee','ff','gg','hh','ii','jj',
'kk','mm','nn','pp','qq','rr','ss','tt','uu','vv',
'ww','xx','yy','zz','ab','ac','ad','ae','af','ag',
'ah','ai','aj','ak','am','an','ap','aq','ar','as',
'at','au','av','aw','ax','ay','az','ba','bc','bd',
'be','bf','bg','bh','bi','bj','bk','bm','bn','bp',
'bq','br','bs','bt','bu','bv','bw','bx','by','bz',
'ca','cb','cd','ce','cf','cg','ch','ci','cj','ck',
'cm','cn','cp','cq','cr','cs','ct','cu','cv','cw',
'cx','cy','cz','da','db','dc','de','df','dg','dh',
'di','dj','dk','dm','dn','dp','dq','dr','ds','dt',
'du','dv','dw','dx','dy','dz','ea','eb','ec','ed',
'ef','eg','eh','ei','ej','ek','em','en','ep','eq',
'er','es','et','eu','ev','ew','ex','ey','ez','fa',
'fb','fc','fd','fe','fg','fh','fi','fj','fk','fm',
'fn','fp','fq','fr','fs','ft','fu','fv','fw','fx',
'fy','fz','ga','gb','gc','gd','ge','gf','gh','gi',
'gj','gk','gm','gn','gp','gq','gr','gs','gt','gu',
'gv','gw','gx','gy','gz','ha','hb','hc','hd','he',
'hf','hg','hi','hj','hk','hm','hn','hp','hq','hr',
'hs','ht','hu','hv','hw','hx','hy','hz','ia','ib',
'ic','id','ie','if','ig','ih','ij','ik','im','in',
'ip','iq','ir','is','it','iu','iv','iw','ix','iy',
'iz','ja','jb','jc','jd','je','jf','jg','jh','ji',
'jk','jm','jn','jp','jq','jr','js','jt','ju','jv',
'jw','jx','jy','jz','ka','kb','kc','kd','ke','kf',
'kg','kh','ki','kj','km','kn','kp','kq','kr','ks',
'kt','ku','kv','kw','kx','ky','kz','ma','mb','mc',
'md','me','mf','mg','mh','mi','mj','mk','mn','mp',
'mq','mr','ms','mt','mu','mv','mw','mx','my','mz',
'na','nb','nc','nd','ne','nf','ng','nh','ni','nj',
'nk','nm','np','nq','nr','ns','nt','nu','nv','nw',
'nx','ny','nz','pa','pb','pc','pd','pe','pf','pg',
'ph','pi','pj','pk','pm','pn','pq','pr','ps','pt',
'pu','pv','pw','px','py','pz','qa','qb','qc','qd',
'qe','qf','qg','qh','qi','qj','qk','qm','qn','qp',
'qr','qs','qt','qu','qv','qw','qx','qy','qz','ra',
'rb','rc','rd','re','rf','rg','rh','ri','rj','rk',
'rm','rn','rp','rq','rs','rt','ru','rv','rw','rx',
'ry','rz','sa','sb','sc','sd','se','sf','sg','sh',
'si','sj','sk','sm','sn','sp','sq','sr','st','su',
'sv','sw','sx','sy','sz','ta','tb','tc','td','te',
'tf','tg','th','ti','tj','tk','tm','tn','tp','tq',
'tr','ts','tu','tv','tw','tx','ty','tz','ua','ub',
'uc','ud','ue','uf','ug','uh','ui','uj','uk','um',
'un','up','uq','ur','us','ut','uv','uw','ux','uy',
'uz','va','vb','vc','vd','ve','vf','vg','vh','vi',
'vj','vk','vm','vn','vp','vq','vr','vs','vt','vu',
'vw','vx','vy','vz','wa','wb','wc','wd','we','wf',
'wg','wh','wi','wj','wk','wm','wn','wp','wq','wr',
'ws','wt','wu','wv','wx','wy','wz','xa','xb','xc',
'xd','xe','xf','xg','xh','xi','xj','xk','xm','xn',
'xp','xq','xr','xs','xt','xu','xv','xw','xy','xz',
'ya','yb','yc','yd','ye','yf','yg','yh','yi','yj',
'yk','ym','yn','yp','yq','yr','ys','yt','yu','yv',
'yw','yx','yz','za','zb','zc','zd','ze','zf','zg',
'zh','zi','zj','zk','zm','zn','zp','zq','zr','zs',
'zt','zu','zv','zw','zx','zy'
];

// --- Utility Functions ---

function getCurrentDateMMDD() {
    const d = new Date();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return month + day;
}

function isValidDate(month, day) {
    if (month < 1 || month > 12 || day < 1 || day > 31) return false;
    if ([4, 6, 9, 11].includes(month) && day > 30) return false;
    if (month === 2 && day > 29) return false;
    return true;
}

function showToast(message, isError = false) {
    // Remove existing toasts first to prevent overlap
    document.querySelectorAll('.toast-notification').forEach(t => t.remove());

    const toast = document.createElement('div');
    toast.className = 'toast-notification'; // Add class for potential removal
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.backgroundColor = isError ? '#f44336' : 'var(--primary-color)';
    toast.style.color = 'white';
    toast.style.padding = '12px 25px';
    toast.style.borderRadius = '6px';
    toast.style.zIndex = '1001';
    toast.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
    toast.style.textAlign = 'center';
    toast.style.fontSize = '0.875em';
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s ease';
    toast.textContent = message;

    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.style.opacity = '1';
    });

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.addEventListener('transitionend', () => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, { once: true }); // Ensure listener is removed after firing
    }, 2500);
}

let loadingOverlay = null;
function showLoading() {
    if (loadingOverlay) return;
    loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = '<div class="spinner"></div>';
    document.body.appendChild(loadingOverlay);
}
function hideLoading() {
    if (loadingOverlay && loadingOverlay.parentNode) {
        loadingOverlay.parentNode.removeChild(loadingOverlay);
    }
    loadingOverlay = null;
}

async function copyToClipboard(text, successMsg) {
    if (!text) {
        showToast('没有内容可复制', true);
        return;
    }
    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            showToast(successMsg || '已复制到剪贴板');
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.top = '-9999px'; // Move off-screen
            textarea.style.left = '-9999px';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            let success = false;
            try {
                 success = document.execCommand('copy');
            } catch (err) {
                 console.warn("Fallback execCommand failed:", err);
            }
            document.body.removeChild(textarea);
            if (success) {
                showToast(successMsg || '已复制到剪贴板 (fallback)');
            } else {
                throw new Error('Fallback copy command failed or denied');
            }
        }
    } catch (err) {
        console.error('复制失败:', err);
        // Provide more specific feedback if possible
        if (err.name === 'NotAllowedError') {
            showToast('复制失败：浏览器权限不足或页面非激活状态', true);
        } else {
            showToast('复制失败，请尝试手动复制', true);
        }
    }
}


// --- Core Functionality ---

function adjustDateSuffix(delta) {
    const input = document.getElementById('dateSuffix');
    let currentValue = input.value.trim();

    if (!/^\d{4}$/.test(currentValue)) {
        const currentMMDD = getCurrentDateMMDD();
        const initialMonth = parseInt(currentValue.substring(0, 2), 10);
        const initialDay = parseInt(currentValue.substring(2, 4), 10);
        if (!isValidDate(initialMonth, initialDay)) {
             input.value = currentMMDD;
             currentValue = currentMMDD;
        } else {
             currentValue = String(initialMonth).padStart(2,'0') + String(initialDay).padStart(2,'0');
             input.value = currentValue;
        }
    }

    const month = parseInt(currentValue.substring(0, 2), 10);
    const day = parseInt(currentValue.substring(2, 4), 10);

    const date = new Date(2024, month - 1, day);
    date.setDate(date.getDate() + delta);

    const newMonth = String(date.getMonth() + 1).padStart(2, '0');
    const newDay = String(date.getDate()).padStart(2, '0');
    input.value = newMonth + newDay;
}

function adjustEmailCount(delta) {
    const input = document.getElementById('emailCount');
    const min = parseInt(input.min, 10);
    const max = parseInt(input.max, 10);
    let currentValue = parseInt(input.value, 10);

    if (isNaN(currentValue)) {
        currentValue = 100;
    }

    let newValue = currentValue + delta;
    newValue = Math.max(min, Math.min(max, newValue));
    input.value = newValue;
}

function generatePassword() {
    const chars = 'abcdefghjkmnpqrstuvwxyz23456789'; // Simplified further
    let password = '';
    // Generate a slightly shorter password for brevity if needed
    for (let i = 0; i < 6; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    // Ensure at least one number maybe?
     if (!/\d/.test(password)) {
         password += Math.floor(Math.random() * 10);
     }
     // Ensure minimum length if needed (pad if too short after adding number)
     while (password.length < 6) {
          password += chars.charAt(Math.floor(Math.random() * chars.length));
     }
    return password.slice(0, 8); // Keep it max 8 chars
}

function generateData() {
    showLoading();

    setTimeout(() => {
        try {
            const dateSuffixInput = document.getElementById('dateSuffix');
            const dateSuffix = dateSuffixInput.value.trim();
            if (!/^\d{4}$/.test(dateSuffix)) {
                showToast("日期后缀格式无效 (应为MMDD)", true);
                dateSuffixInput.focus();
                hideLoading();
                return;
            }
            const month = parseInt(dateSuffix.substring(0, 2), 10);
            const day = parseInt(dateSuffix.substring(2, 4), 10);
            if (!isValidDate(month, day)) {
                 showToast(`日期后缀无效: ${month}月 ${day}日 不存在`, true);
                dateSuffixInput.focus();
                hideLoading();
                return;
            }

            const domainInput = document.getElementById('emailDomain');
            const domain = domainInput.value.trim();
            if (!domain || !domain.startsWith("@")) {
                showToast("邮箱域名必须以@开头", true);
                domainInput.focus();
                hideLoading();
                return;
            }

            const emailCountInput = document.getElementById('emailCount');
            const count = parseInt(emailCountInput.value, 10);
            const minCount = parseInt(emailCountInput.min, 10);
            const maxCount = parseInt(emailCountInput.max, 10);

            if (isNaN(count) || count < minCount || count > maxCount) {
                showToast(`生成数量必须在 ${minCount} 和 ${maxCount} 之间`, true);
                emailCountInput.focus();
                hideLoading();
                return;
            }

            const container = document.getElementById('output-container');
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();

            for (let index = 0; index < count; index++) {
                const prefix = email_prefixes[index % email_prefixes.length];
                const emailAddress = `${prefix}${dateSuffix}${domain}`;
                const password = generatePassword();

                const div = document.createElement('div');
                div.className = 'email-item';
                div.dataset.email = emailAddress;
                div.dataset.password = password;
                div.dataset.index = index + 1;

                div.innerHTML = `
                    <input type="checkbox" class="checkbox" aria-label="Select item ${index + 1}" onchange="toggleSelection(this)">
                    <div class="email-info" title="${emailAddress} ${password}">
                        ${String(index + 1).padStart(3, '0')}. ${emailAddress}  ${password} <!-- Added non-breaking space -->
                    </div>
                    <button class="btn copy-btn" onclick="copySingle(this)">复制</button>
                `;
                fragment.appendChild(div);
            }

            container.appendChild(fragment);
            showToast(`成功生成 ${count} 条数据`);

        } catch (error) {
            console.error("生成失败:", error);
            showToast(`生成失败: ${error.message}`, true);
        } finally {
            hideLoading();
        }
    }, 50);
}


// --- Reset Functions ---
function resetDateSuffix() {
    document.getElementById('dateSuffix').value = getCurrentDateMMDD();
}
function resetEmailDomain() {
    document.getElementById('emailDomain').value = '@e.edu.kg';
}
function resetEmailCount() {
    document.getElementById('emailCount').value = 100;
}


// --- Selection Functions ---
function toggleSelection(checkbox) {
    checkbox.closest('.email-item').classList.toggle('selected', checkbox.checked);
}

function selectAll() {
    let changed = false;
    let count = 0;
    document.querySelectorAll('#output-container .email-item').forEach(item => {
        const checkbox = item.querySelector('.checkbox');
        if (!checkbox.checked) {
             checkbox.checked = true;
             item.classList.add('selected');
             changed = true;
        }
        count++;
    });
    if (count === 0) showToast('没有可选择的条目', true);
    else if (!changed) showToast('所有条目已为选中状态');
}

function invertSelection() {
     let count = 0;
    document.querySelectorAll('#output-container .email-item').forEach(item => {
        const checkbox = item.querySelector('.checkbox');
        checkbox.checked = !checkbox.checked;
        item.classList.toggle('selected', checkbox.checked);
        count++;
    });
     if (count === 0) showToast('没有可反选的条目', true);
}

function getItemText(itemElement) {
    const emailInfo = itemElement.querySelector('.email-info');
    if (!emailInfo) return '';
    // Improved extraction to handle potential extra spaces
    const textContent = emailInfo.textContent || '';
    return textContent.replace(/^\d+\.\s+/, '').trim().replace(/\s+/g, ' '); // Replace multiple spaces with single
}

// --- Copy Functions ---
function copySelected() {
    const selectedItems = document.querySelectorAll('#output-container .email-item.selected');
    if (selectedItems.length === 0) {
        showToast('请先选择要复制的条目', true);
        return;
    }
    const textToCopy = Array.from(selectedItems)
                           .map(item => getItemText(item))
                           .join('\n');
    copyToClipboard(textToCopy, `已复制 ${selectedItems.length} 条选中内容`);
}

function copyRange() {
    const rangeInput = document.getElementById('copyRange');
    const rangeValue = rangeInput.value.trim().replace(/[^0-9-]/g, ''); // Sanitize input further
    const rangeRegex = /^(\d+)-(\d+)$/; // Simpler regex, assuming cleaned input

    if (!rangeValue || !rangeRegex.test(rangeValue)) {
        showToast('请输入正确范围格式 (例: 1-5)', true);
        rangeInput.focus();
        return;
    }

    const match = rangeValue.match(rangeRegex);
    // Check if match exists before accessing groups
    if (!match) {
        showToast('范围格式解析失败 (例: 1-5)', true);
        rangeInput.focus();
        return;
    }
    const start = parseInt(match[1], 10);
    const end = parseInt(match[2], 10);

    const allItems = document.querySelectorAll('#output-container .email-item');
    const totalItems = allItems.length;

    if (totalItems === 0) {
        showToast("请先生成数据", true);
        return;
    }

    // More robust validation
    if (isNaN(start) || isNaN(end) || start < 1 || end > totalItems || start > end) {
        showToast(`无效范围 (请输入 1 到 ${totalItems} 之间, 且开始 ≤ 结束)`, true);
        rangeInput.focus();
        return;
    }

    const itemsToCopy = Array.from(allItems)
        .slice(start - 1, end)
        .map(item => getItemText(item));

    if (itemsToCopy.length > 0) {
        copyToClipboard(itemsToCopy.join('\n'), `已复制范围 ${start}-${end} (${itemsToCopy.length}条)`);
    } else {
         showToast(`指定范围内没有找到条目 (范围: ${start}-${end})`, true);
    }
}

function copySingle(button) {
    const itemElement = button.closest('.email-item');
    const text = getItemText(itemElement);
    copyToClipboard(text, '已复制单条内容');
}

function copyAll() {
    const allItems = document.querySelectorAll('#output-container .email-item');
    if (allItems.length === 0) {
        showToast("没有内容可复制", true);
        return;
    }
    const textToCopy = Array.from(allItems)
                           .map(item => getItemText(item))
                           .join('\n');
    copyToClipboard(textToCopy, `已复制全部 ${allItems.length} 条内容`);
}


// --- Export Function ---
function exportTXT() {
    const allItems = document.querySelectorAll('#output-container .email-item');
     if (allItems.length === 0) {
        showToast("没有内容可导出", true);
        return;
    }
    const textToExport = Array.from(allItems)
                             .map(item => getItemText(item))
                             .join('\r\n');

    const blob = new Blob([textToExport], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const domainPart = (document.getElementById('emailDomain').value.split('@')[1] || 'domain').split('.')[0];
    a.download = `邮箱列表_${domainPart}_${dateStr}_${allItems.length}条.txt`;

    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
        URL.revokeObjectURL(url);
        if (a.parentNode) {
             document.body.removeChild(a);
        }
        showToast(`已开始导出 ${allItems.length} 条数据`);
    }, 100);
}

// --- Sort Function ---
function sortData(type) {
    const container = document.getElementById('output-container');
    // Ensure we only get direct children that are email items
    const items = Array.from(container.querySelectorAll(':scope > .email-item'));

    if (items.length === 0) {
        showToast("没有可排序的数据", true);
        return;
    }

    items.forEach(item => container.removeChild(item)); // Detach before sorting

    switch (type) {
        case 'asc':
            items.sort((a, b) => (parseInt(a.dataset.index || '0') - parseInt(b.dataset.index || '0')));
            break;
        case 'desc':
            items.sort((a, b) => (parseInt(b.dataset.index || '0') - parseInt(a.dataset.index || '0')));
            break;
        case 'random':
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            break;
        default: // Should not happen, but good practice
            console.warn("Unknown sort type:", type);
            // Re-append in original detached order if type is invalid
             items.forEach(item => container.appendChild(item));
            return;
    }

    const fragment = document.createDocumentFragment();
    items.forEach(item => fragment.appendChild(item));
    container.appendChild(fragment); // Append sorted items

    const sortTypeText = type === 'asc' ? '顺序' : type === 'desc' ? '倒序' : '随机';
    showToast(`数据已按 ${sortTypeText} 排序`);
}


// --- Initial Setup ---
document.addEventListener('DOMContentLoaded', () => {
    resetDateSuffix();

    // iOS focus/blur scroll fix attempt
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent || '') && !window.MSStream;
    if (isIOS) {
        document.body.addEventListener('focusout', (e) => {
             if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                // Briefly delay to allow keyboard to potentially start dismissing
                setTimeout(() => {
                    window.scrollTo({ top: window.scrollY, behavior: 'auto' }); // 'auto' might be less jarring
                }, 50);
             }
        }, true); // Use capture phase might sometimes help
    }
});

</script>
</body>
</html>
